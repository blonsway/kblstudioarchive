<!DOCTYPE html>
<html lang="en">
<head>
	<script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>
	<h1>This is a timeline that autopopulates from wp posts.</h1>
	

	<script type="text/javascript">
		
		var svgWidth = window.innerWidth-200;
		var svgHeight = 800;
		var svgPadding = 20;

		var startYear = 1990;
		var endYear = 2023;

		var timelinesvg = d3.select("body")
			.append("svg")
			.attr("width", svgWidth)
			.attr("height", svgHeight)
			.attr("margin", "20px"); 
		
		var projectData;

		d3.json("https://archive.kblstudio.com/wp-json/wp/v2/project").then(function(data) {projectData = data;console.log("loaded json: "+projectData);});
		

		function getYears (data) {
			console.log("in getYears function");

			//sort post array on year
			var sortedData = data.slice().sort((a,b) => d3.ascending(a['toolset-meta']['project-fields'].year.raw, b['toolset-meta']['project-fields'].year.raw));			


			// create scale for years based on start year and end year
			var timeScaleYears = d3.scaleTime()
				.domain([startYear, endYear])
				.range([svgPadding,svgWidth-svgPadding])
				.nice();

			//create x axis
			var xAxis = d3.axisBottom(timeScaleYears)
				.ticks(endYear-startYear)
				.tickFormat(d3.format("d"));

			var vertDistribScale = d3.scaleLinear()
				.domain([0,data.length])
				.range([svgPadding,svgHeight/2])
				.nice();
		
			var baseYpos = 50; //pixels above axis for first data point
			var stackedItemYpos = baseYpos;

			timelinesvg.selectAll("points")
				.data(sortedData)
				.enter()
				.append("circle")
					.attr("fill","#fc3")
					.attr("stroke", "none")
					.attr("cx", function(d) {return timeScaleYears(d['toolset-meta']['project-fields'].year.raw);})
					.attr("cy", function(d,i) {return svgHeight-vertDistribScale(i);})
					.attr("r", 5);


			timelinesvg.selectAll("points")
				.data(sortedData)
				.enter()
				.append("a")
					.attr("xlink:href", function(d){ return d.link })
				.append("text")
					.attr("x", function(d) {return timeScaleYears(d['toolset-meta']['project-fields'].year.raw);})
					.attr("y", function(d,i) {return svgHeight-vertDistribScale(i)+10;})
					.attr("dy", ".3em")
					.text(function(d) {return (d.title.rendered);})
					.on("mouseover", function(d,i) {
						d3.select("#projImage"+i)
							.transition()
							.duration(300)
							.attr("opacity", 1)
						})
					.on("mouseout", function(d,i) {
						d3.select("#projImage"+i)
							.transition()
							.duration(300)
							.attr("opacity", 0)
						});


			timelinesvg.selectAll("image")
				.data(sortedData)
				.enter()
				.append("image")
					.attr("xlink:href", function(d){ return d['toolset-meta']['project-fields']['main-image'].raw })
					.attr("id", function(d,i) {return "projImage" + i})
					.attr("width",100)
					.attr("height",200)
					.attr("x", function(d) {return timeScaleYears(d['toolset-meta']['project-fields'].year.raw)+100;})
					.attr("y", function(d,i) {return vertDistribScale(i);})
					.attr("opacity","0");


			timelinesvg.append("g")
				.attr("transform", "translate(0,"+(svgHeight-40)+")")
				.call(xAxis)
				.selectAll("text")
					.style("text-anchor","end")
					.attr("dx","-1em")
					.attr("dy","-.5em")
					.attr("transform","rotate(-90)");


		}


	</script>
</body>
</html>
